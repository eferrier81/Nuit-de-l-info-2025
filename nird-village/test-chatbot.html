<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Chatbot - Chat'rlatan</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0a0a0a;
      color: #32c96b;
    }
    .test-section {
      background: #1a1a1a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      border: 2px solid #32c96b;
    }
    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 5px;
      margin: 5px;
      font-weight: bold;
    }
    .status.success { background: #32c96b; color: #000; }
    .status.error { background: #ff6b6b; color: #fff; }
    .status.warning { background: #ffd447; color: #000; }
    button {
      background: #32c96b;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 5px;
    }
    button:hover {
      background: #45e07f;
    }
    pre {
      background: #000;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .response {
      background: #2a2a2a;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #32c96b;
    }
  </style>
</head>
<body>
  <h1>Test du Chatbot Chat'rlatan</h1>
  
  <div class="test-section">
    <h2>1. Configuration</h2>
    <div id="config-status"></div>
    <pre id="config-details"></pre>
  </div>

  <div class="test-section">
    <h2>2. Test de connexion API</h2>
    <button onclick="testAPI()">Tester l'API OpenAI</button>
    <div id="api-status"></div>
    <div id="api-response" class="response" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>3. Tests de conversation</h2>
    <button onclick="testMessage('Bonjour !')">Test 1: Salutation</button>
    <button onclick="testMessage('Qu\'est-ce que le NIRD ?')">Test 2: NIRD</button>
    <button onclick="testMessage('Parle-moi de Windows')">Test 3: Windows</button>
    <div id="conversation-results"></div>
  </div>

  <div class="test-section">
    <h2>4. Logs</h2>
    <button onclick="clearLogs()">Effacer les logs</button>
    <pre id="logs"></pre>
  </div>

  <script src="js/config.js"></script>
  <script>
    // Fonction de log
    function log(message, type = 'info') {
      const logsEl = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '[ERROR]' : type === 'success' ? '[OK]' : '[INFO]';
      logsEl.textContent += `${prefix} [${timestamp}] ${message}\n`;
      console.log(`[${type}]`, message);
    }

    function clearLogs() {
      document.getElementById('logs').textContent = '';
    }

    // Vérifier la configuration
    function checkConfig() {
      const statusEl = document.getElementById('config-status');
      const detailsEl = document.getElementById('config-details');
      
      if (typeof CHATBOT_CONFIG === 'undefined') {
        statusEl.innerHTML = '<span class="status error">Erreur: config.js non chargé</span>';
        log('Config non chargé', 'error');
        return false;
      }

      let status = [];
      let isValid = true;

      // Vérifier la clé API
      if (!CHATBOT_CONFIG.OPENAI_API_KEY || CHATBOT_CONFIG.OPENAI_API_KEY === 'votre-cle-api-ici') {
        status.push('<span class="status error">Clé API manquante</span>');
        log('Clé API non configurée', 'error');
        isValid = false;
      } else {
        const keyPreview = CHATBOT_CONFIG.OPENAI_API_KEY.substring(0, 10) + '...';
        status.push('<span class="status success">Clé API configurée (' + keyPreview + ')</span>');
        log('Clé API trouvée', 'success');
      }

      // Vérifier le mode
      if (CHATBOT_CONFIG.USE_AI) {
        status.push('<span class="status success">Mode IA activé</span>');
        log('Mode IA activé', 'success');
      } else {
        status.push('<span class="status warning">Mode local (sans IA)</span>');
        log('Mode local actif', 'info');
      }

      statusEl.innerHTML = status.join('');
      
      // Afficher les détails
      detailsEl.textContent = JSON.stringify({
        MODEL: CHATBOT_CONFIG.MODEL,
        MAX_TOKENS: CHATBOT_CONFIG.MAX_TOKENS,
        TEMPERATURE: CHATBOT_CONFIG.TEMPERATURE,
        USE_AI: CHATBOT_CONFIG.USE_AI
      }, null, 2);

      return isValid;
    }

    // Tester l'API
    async function testAPI() {
      const statusEl = document.getElementById('api-status');
      const responseEl = document.getElementById('api-response');
      
      if (!checkConfig()) {
        statusEl.innerHTML = '<span class="status error">Configuration invalide</span>';
        return;
      }

      if (!CHATBOT_CONFIG.USE_AI) {
        statusEl.innerHTML = '<span class="status warning">Mode IA désactivé (USE_AI: false)</span>';
        log('Test API ignoré: mode IA désactivé', 'info');
        return;
      }

      statusEl.innerHTML = '<span class="status">Test en cours...</span>';
      log('Envoi d\'une requête test à OpenAI...', 'info');
      responseEl.style.display = 'none';

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CHATBOT_CONFIG.OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: CHATBOT_CONFIG.MODEL,
            messages: [
              {
                role: 'system',
                content: 'Tu es un chatbot de test. Réponds simplement "Test réussi !"'
              },
              {
                role: 'user',
                content: 'Test'
              }
            ],
            max_tokens: 20
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        statusEl.innerHTML = '<span class="status success">API OpenAI fonctionne !</span>';
        responseEl.innerHTML = `<strong>Réponse:</strong> ${data.choices[0].message.content}`;
        responseEl.style.display = 'block';
        log('API OpenAI: Test réussi', 'success');
        log(`Modèle utilisé: ${data.model}`, 'info');

      } catch (error) {
        statusEl.innerHTML = '<span class="status error">Erreur API</span>';
        responseEl.innerHTML = `<strong>Erreur:</strong> ${error.message}`;
        responseEl.style.display = 'block';
        log(`Erreur API: ${error.message}`, 'error');
      }
    }

    // Tester un message
    async function testMessage(message) {
      const resultsEl = document.getElementById('conversation-results');
      log(`Test de message: "${message}"`, 'info');
      
      const resultDiv = document.createElement('div');
      resultDiv.className = 'response';
      resultDiv.innerHTML = `<strong>Vous:</strong> ${message}<br><strong>Chat'rlatan:</strong> <span style="color: #ffd447;">En cours...</span>`;
      resultsEl.appendChild(resultDiv);

      try {
        if (!CHATBOT_CONFIG.USE_AI) {
          resultDiv.innerHTML = `<strong>Vous:</strong> ${message}<br><strong>Chat'rlatan:</strong> Mode local activé (réponses prédéfinies)`;
          log('Message traité en mode local', 'info');
          return;
        }

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CHATBOT_CONFIG.OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: CHATBOT_CONFIG.MODEL,
            messages: [
              {
                role: 'system',
                content: CHATBOT_CONFIG.SYSTEM_PROMPT
              },
              {
                role: 'user',
                content: message
              }
            ],
            max_tokens: CHATBOT_CONFIG.MAX_TOKENS,
            temperature: CHATBOT_CONFIG.TEMPERATURE
          })
        });

        const data = await response.json();
        const aiResponse = data.choices[0].message.content;
        
        resultDiv.innerHTML = `<strong>Vous:</strong> ${message}<br><strong>Chat'rlatan:</strong> ${aiResponse}`;
        log(`Réponse reçue pour "${message}"`, 'success');

      } catch (error) {
        resultDiv.innerHTML = `<strong>Vous:</strong> ${message}<br><strong>Erreur:</strong> ${error.message}`;
        log(`Erreur pour "${message}": ${error.message}`, 'error');
      }
    }

    // Vérifier la config au chargement
    window.addEventListener('DOMContentLoaded', () => {
      log('Page de test chargée', 'info');
      checkConfig();
    });
  </script>
</body>
</html>
